<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vishwamber Reddy">
<meta name="author" content="Caoyu Shao">
<meta name="author" content="Hongyu Yin">

<title>The Relationship Between Life Expectancy and the Gini Coefficient</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Assignment-3_files/libs/clipboard/clipboard.min.js"></script>
<script src="Assignment-3_files/libs/quarto-html/quarto.js"></script>
<script src="Assignment-3_files/libs/quarto-html/popper.min.js"></script>
<script src="Assignment-3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Assignment-3_files/libs/quarto-html/anchor.min.js"></script>
<link href="Assignment-3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Assignment-3_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Assignment-3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Assignment-3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Assignment-3_files/libs/bootstrap/bootstrap-32162a2fca7cb0439643f2faaab1edf3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link active" data-scroll-target="#executive-summary">Executive summary:</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction:</a></li>
  <li><a href="#research-question" id="toc-research-question" class="nav-link" data-scroll-target="#research-question">Research Question</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology:</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results:</a></li>
  <li><a href="#discussion-conclusion-and-recommendations" id="toc-discussion-conclusion-and-recommendations" class="nav-link" data-scroll-target="#discussion-conclusion-and-recommendations">Discussion, conclusion and recommendations</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References:</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The Relationship Between Life Expectancy and the Gini Coefficient</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Vishwamber Reddy </p>
             <p>Caoyu Shao </p>
             <p>Hongyu Yin </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="executive-summary" class="level3">
<h3 class="anchored" data-anchor-id="executive-summary">Executive summary:</h3>
<p>This study examines the relationship between income inequality and life expectancy across nations from 1990 to 2020 using World Bank and Our World in Data sources. Our analysis reveals a negative correlation between income inequality (measured by the Gini coefficient) and life expectancy, with more equitable societies generally experiencing longer life spans.</p>
<p>While global life expectancy has increased over the study period, the persistence of high inequality in certain regions continues to correspond with lower life expectancy outcomes. These findings suggest that addressing income inequality could be an important factor in improving population health outcomes.</p>
</section>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction:</h3>
<p>The gap between rich and poor has become a defining challenge of our time, with potential implications for population health that extend far beyond economic considerations. While medical advances and improved living standards have generally increased life expectancy worldwide, the benefits of these improvements are not equally distributed. Recent studies suggest that the degree of income inequality within a society may play a crucial role in determining health outcomes.</p>
<p>Our investigation aims to contribute to the ongoing debate about whether more equitable societies tend to be healthier societies, and what this might mean for public policy. Understanding these patterns is essential for policymakers seeking to improve both economic and health outcomes in their communities.</p>
</section>
<section id="research-question" class="level3">
<h3 class="anchored" data-anchor-id="research-question">Research Question</h3>
<p>Primary Research Question:</p>
<ul>
<li>What is the relationship between income inequality and life expectancy across different countries between 1990-2020?</li>
</ul>
<p>Secondary Research Questions:</p>
<ol type="1">
<li><p>How has the correlation between income inequality and life expectancy changed over the three-decade period?</p></li>
<li><p>Do countries with similar Gini coefficients show comparable life expectancy patterns regardless of their geographical location?</p></li>
</ol>
</section>
<section id="methodology" class="level3">
<h3 class="anchored" data-anchor-id="methodology">Methodology:</h3>
<p>To investigate the relationship between income inequality and life expectancy, we analyzed data from two primary sources: life expectancy data from Our World in Data and Gini coefficient data from the World Bank. The analysis focused on the period from 1990 to 2020, covering multiple countries worldwide.</p>
<p>The Gini coefficient, ranging from 0 to 1, measures income inequality within countries, where 0 represents perfect equality and 1 represents maximum inequality. Life expectancy at birth represents the average number of years a newborn would live under current mortality rates.</p>
<p>We performed the following data processing and analysis steps:</p>
<ol type="1">
<li><p>Data cleaning by removing missing values and standardizing country names</p></li>
<li><p>Merging the datasets based on country and year</p></li>
<li><p>Computing summary statistics and correlation analysis</p></li>
<li><p>Creating visualizations to examine relationships and trends</p></li>
</ol>
<p>The cross-sectional analysis examined the relationship between life expectancy and Gini coefficient at select years. The longitudinal analysis tracked changes in both variables across time.</p>
<p>Table and Figure References:</p>
<p>As shown in Table 1, the average life expectancy was 72.82 years (SD = 7.84), and the average Gini coefficient was 0.38 (SD = 0.09), reflecting substantial variability across countries.</p>
<div class="cell">
<div id="tbl-summary-stats" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-summary-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Summary statistics for life expectancy and Gini coefficient (1990-2020)
</figcaption>
<div aria-describedby="tbl-summary-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Mean_Life_Expectancy</th>
<th style="text-align: right;">SD_Life_Expectancy</th>
<th style="text-align: right;">Mean_Gini</th>
<th style="text-align: right;">SD_Gini</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">72.81685</td>
<td style="text-align: right;">7.835837</td>
<td style="text-align: right;">0.3756492</td>
<td style="text-align: right;">0.0881552</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Figure 1 illustrates trends over time, showing a steady increase in life expectancy and a mild decline in income inequality from 1990 to 2020.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-time-trends" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-time-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Assignment-3_files/figure-html/fig-time-trends-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-time-trends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Global trends in life expectancy and Gini coefficient from 1990 to 2020
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results:</h3>
<p>Our results demonstrate a negative correlation between income inequality and life expectancy (r = -0.45). Countries with higher Gini coefficients tend to have lower life expectancy.</p>
<p>Over the 30-year period, life expectancy increased globally from approximately 70 years in 1990 to 76 years in 2020. Meanwhile, income inequality slightly declined, with the average Gini coefficient decreasing from 0.39 to 0.35.</p>
<p>Figure 2 presents cross-sectional snapshots by decade. The scatter plots show a persistent negative relationship across time points, supporting the association between inequality and health outcomes.</p>
<p>Notably, countries with Gini coefficients below 0.3 generally achieved life expectancies above 80 years, while nations with coefficients above 0.45 frequently had life expectancies under 70 years.</p>
<p>The relationship remained consistent across decades, though the strength of the correlation varied by region and development level. This suggests that while income inequality is an important factor in life expectancy, other variables likely play significant roles in determining population health outcomes.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-scatter-decades" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scatter-decades-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Assignment-3_files/figure-html/fig-scatter-decades-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scatter-decades-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Relationship between income inequality and life expectancy
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-country-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-country-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Assignment-3_files/figure-html/fig-country-comparison-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-country-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Comparison of life expectancy and income inequality
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="discussion-conclusion-and-recommendations" class="level3">
<h3 class="anchored" data-anchor-id="discussion-conclusion-and-recommendations">Discussion, conclusion and recommendations</h3>
<p>We have discussed the relationship between the gini-coefficient and life expectations. We conclude that the two variables have negative relations, A negative correlation between life expectancy and the Gini coefficient means that, on average, countries (or regions) with greater income inequality tend to have shorter lifespans. The main channels driving this relationship are:</p>
<ol type="1">
<li>Unequal Access to Resources</li>
</ol>
<p>Healthcare: Wealthier individuals can afford higher-quality care, preventive screenings, and insurance, while poorer people may delay or forgo treatment due to cost.</p>
<p>Nutrition &amp; Living Conditions: Affluent households can buy healthier food and live in cleaner, less crowded environments; low-income families face greater exposure to pollution, overcrowding, and food insecurity.</p>
<ol start="2" type="1">
<li>Psychosocial Stress and Social Capital</li>
</ol>
<p>Chronic Stress: Large income gaps fuel social comparison and status anxiety, triggering persistent stress responses that harm cardiovascular, immune, and endocrine systems.</p>
<p>Weakened Community Bonds: High-inequality societies often exhibit lower trust and mutual support, reducing the informal networks that share health information and provide neighborhood‐level care.</p>
<ol start="3" type="1">
<li>Underinvestment in Public Health and Welfare</li>
</ol>
<p>Weak Redistribution: When tax, welfare, and public services disproportionately benefit the well-off, funding for universal healthcare, elder care, and child health programs suffers—limiting gains in overall longevity.</p>
<p>Education Gaps: Education strongly influences health literacy and behaviors; in unequal societies, lower-educated groups lack knowledge about disease prevention and healthy lifestyles, increasing chronic‐disease risks.</p>
<ol start="4" type="1">
<li>Cumulative and Intergenerational Effects</li>
</ol>
<p>Early-Life Disadvantages: Childhood poverty—malnutrition, exposure to toxins, or family financial stress—can stunt physical and cognitive development, with effects that persist into adulthood.</p>
<p>Limited Social Mobility: In highly unequal settings, children from poor families have fewer opportunities to escape poverty, perpetuating health disadvantages across generations.</p>
<p>In summary, higher Gini coefficients signal deeper divides in income, opportunity, and social support. These divides translate into unequal healthcare, nutrition, education, and chronic stress—together driving down average life expectancy. Policies that reduce inequality (stronger redistribution, universal health coverage, and investments in education and social services) therefore play a key role in boosting population health and longevity.</p>
<p>According to our discussion, we get a conclusion that there is a negative relationship between gini-coefficient and life-expectation. We get four explanations for that.</p>
<p>First, due to resource inequality, there will be more poor people and less rich people if there is a high gini coefficient. Rich people could afford higher-quality care, preventive screenings, and insurance, while poorer people may delay or forgo treatment due to cost. And besides Affluent households can buy healthier food and live in cleaner, less crowded environments; low-income families face greater exposure to pollution, overcrowding, and food insecurity.</p>
<p>Second, due to Psychosocial Stress and Social Capital, large income gaps fuel social comparison and status anxiety, triggering persistent stress responses that harm cardiovascular, immune, and endocrine systems. What’s more, High-inequality societies often exhibit lower trust and mutual support, reducing the informal networks that share health information and provide neighborhood‐level care.</p>
<p>Third, due to underinvestment in Public Health and Welfare.When tax, welfare, and public services disproportionately benefit the well-off, funding for universal healthcare, elder care, and child health programs suffers—limiting gains in overall longevity.Besides, Education strongly influences health literacy and behaviors; in unequal societies, lower-educated groups lack knowledge about disease prevention and healthy lifestyles, increasing chronic‐disease risks.</p>
<p>Lastly,due to cumulative and Intergenerational Effect, Childhood poverty—malnutrition, exposure to toxins, or family financial stress—can stunt physical and cognitive development, with effects that persist into adulthood.Besides, in highly unequal settings, children from poor families have fewer opportunities to escape poverty, perpetuating health disadvantages across generations.</p>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References:</h3>
<p>De Vogli, R., Mistry, R., Gnesotto, R., &amp; Cornia, G. A. (2005). Has the relation between income inequality and life expectancy disappeared? Evidence from Italy and top industrialised countries. Journal of Epidemiology &amp; Community Health, 59(2), 158–162. https://doi.org/10.1136/jech.2004.020651 ResearchGate</p>
<ul>
<li><p>Preston, S. H. (1975). The changing relation between mortality and level of economic development. Population Studies, 29(2), 231–248. JSTOR</p></li>
<li><p>Hazan, M. (2012). Life expectancy and schooling: new insights from cross‐country data. Journal of Population Economics, 25, 1237–1248. https://doi.org/10.1007/s00148-011-0392-6 SpringerLink</p></li>
<li><p>Jaba, E., Bălan, C. B., &amp; Robu, I.-B. (2014). The relationship between life expectancy at birth and health expenditures estimated by a cross‐country and time‐series analysis. Procedia Economics and Finance, 15, 108–114. DergiPark</p></li>
<li><p>Tripathi, S., &amp; Maiti, M. (2023). Does urbanization improve health outcomes: a cross country level analysis. Asia‐Pacific Journal of Regional Science, 7, 277–316. https://doi.org/10.1007/s41685-022-00268-1 SpringerLink</p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>